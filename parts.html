<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Two Little Bees ‚Äì Parts Inventory</title>
  <meta name="description" content="Two Little Bees Auto Parts ‚Äî yard parts inventory with pricing, warranty, and interchange info." />
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0b0f14">

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --panel-soft:#0f172a;
      --card:#0e1726;

      --text:#f9fafb;
      --muted:#9ca3af;

      --accent:#f4c430;
      --accent2:#ffb703;

      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 16px;

      --max: 1100px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(244,196,48,.10), transparent 55%),
        radial-gradient(900px 500px at 90% 5%, rgba(255,183,3,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 18%),
        var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; }

    .wrap{ max-width:var(--max); margin:0 auto; padding:18px; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--border); border-radius:var(--radius);
      background:rgba(17,24,39,.70); backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(244,196,48,.95), rgba(255,183,3,.75));
      border:1px solid rgba(0,0,0,.25);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title b{
      font-size:14px; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .title span{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .navbtns{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(244,196,48,.45);
      background: linear-gradient(180deg, rgba(244,196,48,.20), rgba(255,183,3,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.45);
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }

    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border:1px solid var(--border);
      border-radius:999px; background: rgba(0,0,0,.15);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .pill .dot{ width:8px; height:8px; border-radius:99px; background: var(--muted); }
    .pill.live .dot{ background: var(--ok); }
    .pill.err .dot{ background: var(--danger); }
    .pill.admin .dot{ background: var(--accent); }

    .hero{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 4px);
      background: linear-gradient(180deg, rgba(17,24,39,.75), rgba(15,23,42,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero-inner{ padding:18px; }
    .hero h1{ margin:0 0 6px 0; font-size:20px; letter-spacing:.2px; }
    .hero p{ margin:0; color:var(--muted); line-height:1.35; font-size:13px; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .65fr .65fr .7fr .7fr;
      gap:10px;
      padding:14px 18px 18px 18px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    @media (max-width: 920px){
      .controls{ grid-template-columns: 1fr 1fr; }
      .controls .span2{ grid-column: span 2; }
      .controls .spanFull{ grid-column: 1 / -1; }
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select{
      width:100%;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 12px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(244,196,48,.55);
      box-shadow: 0 0 0 3px rgba(244,196,48,.10);
    }

    .grid{ margin-top:16px; display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .card{
      grid-column: span 12;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,24,39,.65);
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .list-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.14);
      flex-wrap:wrap;
    }
    .list-head .left{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .list-head .left b{ font-size:14px; }
    .list-head .left span{ font-size:12px; color:var(--muted); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .mini{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .mini:hover{ background: rgba(255,255,255,.06); }
    .mini.primary{ border-color: rgba(244,196,48,.45); background: rgba(244,196,48,.12); }
    .mini.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }

    .tableWrap{ width:100%; overflow:auto; }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align: top;
      font-size:13px;
    }
    .table th{
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.10);
      position: sticky;
      top: 82px;
      z-index: 5;
    }
    @media (max-width: 920px){ .table th{ top: 132px; } }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .bdot{ width:8px; height:8px; border-radius:99px; background: var(--muted); }
    .bdot.ok{ background: var(--ok); }
    .bdot.warn{ background: var(--warn); }
    .bdot.danger{ background: var(--danger); }

    .muted{ color:var(--muted); }
    .price{ font-weight:800; letter-spacing:.2px; }
    .empty{ padding:18px; color:var(--muted); text-align:center; }

    .pager{
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 18px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.92);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.14);
    }
    .modal header b{ font-size:14px; }
    .modal header .x{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      color:var(--text);
      user-select:none;
    }
    .modal header .x:hover{ background: rgba(255,255,255,.06); }

    .modal .body{ padding:14px 16px 16px 16px; }
    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .form .full{ grid-column: 1 / -1; }
    @media (max-width: 720px){ .form{ grid-template-columns: 1fr; } }

    textarea{
      width:100%;
      min-height:84px;
      resize:vertical;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(244,196,48,.55);
      box-shadow: 0 0 0 3px rgba(244,196,48,.10);
    }

    .modal .footer{
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:12px 16px 16px 16px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .footer-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .footer-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.70);
      border:1px solid var(--border);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      display:none;
      z-index: 99;
      max-width: min(720px, calc(100% - 24px));
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      font-size:13px;
    }

    .footer-note{
      margin: 14px 0 26px 0;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-bottom-color: rgba(0,0,0,.35);
      border-radius: 8px;
      background: rgba(0,0,0,.18);
      color: var(--text);
    }
    mark{
      background: rgba(244,196,48,.18);
      color: var(--text);
      padding:0 2px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" title="Two Little Bees Auto Parts">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Two Little Bees ‚Äî Parts Inventory</b>
          <span>Warranty ‚Ä¢ Price ‚Ä¢ Interchanges ‚Ä¢ Vehicle fitment</span>
        </div>
      </div>

      <div class="navbtns">
        <a class="btn" href="index.html">‚¨ÖÔ∏è Landing</a>
        <a class="btn" href="https://twolittlebeesautoparts.github.io/">üöó Cars</a>

        <button class="btn primary" id="btnAdmin" type="button">üîí Admin</button>
        <button class="btn danger" id="btnLogoutTop" type="button" style="display:none;">üö™ Logout</button>

        <span class="pill live" id="statusPill">
          <span class="dot"></span><span id="statusText">Live ‚Ä¢ Firestore</span>
        </span>

        <span class="pill" id="authPill"><span class="dot"></span><span id="authText">Public view</span></span>
        <span class="pill" id="countPill">0 parts</span>
      </div>
    </div>

    <section class="hero">
      <div class="hero-inner">
        <h1>Find Parts Fast</h1>
        <p>Search includes part + notes + interchange + vehicle fitment (year/make/model/engine).</p>
      </div>

      <div class="controls">
        <div class="field span2">
          <label for="q">Search</label>
          <input id="q" type="text" placeholder="Example: 2014 Ram 5.7, alternator, mirror..." autocomplete="off" />
        </div>

        <div class="field">
          <label for="cat">Category</label>
          <select id="cat"><option value="">All</option></select>
        </div>

        <div class="field">
          <label for="cond">Condition</label>
          <select id="cond">
            <option value="">All</option>
            <option>Used</option>
            <option>New</option>
            <option>Reman</option>
            <option>Core</option>
          </select>
        </div>

        <div class="field">
          <label for="sort">Sort</label>
          <select id="sort">
            <option value="newest">Newest</option>
            <option value="priceAsc">Price (Low ‚Üí High)</option>
            <option value="priceDesc">Price (High ‚Üí Low)</option>
            <option value="nameAsc">Name (A ‚Üí Z)</option>
          </select>
        </div>

        <div class="field">
          <label for="pageSize">Per Page</label>
          <select id="pageSize">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="field spanFull">
          <label>&nbsp;</label>
          <button class="btn" id="btnClear" type="button">üßπ Clear filters</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="card">
        <div class="list-head">
          <div class="left">
            <b>Available Parts</b>
            <span class="muted">Tip: press <span class="kbd">/</span> to jump to search ‚Ä¢ <span class="kbd">Esc</span> closes admin.</span>
          </div>
          <div class="actions"></div>
        </div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th style="min-width:190px;">Part</th>
                <th style="min-width:130px;">Category</th>
                <th style="min-width:110px;">Condition</th>
                <th style="min-width:220px;">Vehicle Fitment</th>
                <th style="min-width:120px;">Price</th>
                <th style="min-width:220px;">Warranty</th>
                <th style="min-width:240px;">Interchange</th>
                <th style="min-width:170px;">Yard / Notes</th>
                <th style="min-width:190px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="empty" id="empty" style="display:none;">No parts match your search.</div>

        <div class="pager" id="pager" style="display:none;">
          <div class="left">
            <span class="pill" id="pagerInfo">Page 1</span>
            <span class="muted" id="rangeInfo" style="font-size:12px;">‚Äî</span>
          </div>
          <div class="right">
            <button class="mini" id="btnPrev" type="button">‚¨ÖÔ∏è Prev</button>
            <button class="mini" id="btnNext" type="button">Next ‚û°Ô∏è</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-note">
      Hablamos Espa√±ol ‚Ä¢ Call: <b>(317) 243-7777</b> ‚Ä¢ 507 S Tibbs Ave, Indianapolis
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Admin Panel">
    <div class="modal">
      <header>
        <b id="modalTitle">Admin</b>
        <button class="x" id="btnCloseModal" type="button" aria-label="Close">‚úï</button>
      </header>

      <div class="body">
        <!-- LOGIN -->
        <div id="adminLogin">
          <div class="form" style="margin-top:6px;">
            <div class="field full">
              <label>Email</label>
              <input id="loginEmail" type="email" autocomplete="email" placeholder="admin@email.com" />
            </div>
            <div class="field full">
              <label>Password</label>
              <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn primary" id="btnLogin" type="button">Log In</button>
            <button class="btn" id="btnCancelLogin" type="button">Cancel</button>
          </div>

          <p class="muted" style="margin:10px 0 0 0; font-size:12px;">
            If login doesn‚Äôt work, check Firebase Auth ‚ÄúAuthorized domains‚Äù (GitHub Pages domain must be added).
          </p>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
            <span class="badge"><span class="bdot ok"></span> Admin logged in</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="mini" id="btnNew" type="button">‚ûï Add new part</button>
              <button class="mini danger" id="btnLogout" type="button">üö™ Logout</button>
            </div>
          </div>

          <datalist id="dlPartNames"></datalist>
          <datalist id="dlMakes"></datalist>
          <datalist id="dlModels"></datalist>
          <datalist id="dlEngines"></datalist>
          <datalist id="dlLocations"></datalist>

          <form class="form" id="partForm" onsubmit="return false;">
            <div class="field">
              <label>Part Name *</label>
              <input id="f_name" list="dlPartNames" placeholder="Ex: Alternator / Engine / Mirror" />
            </div>

            <div class="field">
              <label>Category *</label>
              <select id="f_category"></select>
            </div>

            <div class="field">
              <label>Condition</label>
              <select id="f_condition">
                <option>Used</option>
                <option>New</option>
                <option>Reman</option>
                <option>Core</option>
              </select>
            </div>

            <div class="field">
              <label>Warranty</label>
              <select id="f_warranty"></select>
            </div>

            <div class="field">
              <label>Year</label>
              <input id="f_year" inputmode="numeric" placeholder="Ex: 2014" />
            </div>

            <div class="field">
              <label>Make</label>
              <input id="f_make" list="dlMakes" placeholder="Ex: Ram, Ford, Chevy" />
            </div>

            <div class="field">
              <label>Model</label>
              <input id="f_model" list="dlModels" placeholder="Ex: 1500, Silverado, Accord" />
            </div>

            <div class="field">
              <label>Trim</label>
              <input id="f_trim" placeholder="Ex: Laramie, LT, Sport" />
            </div>

            <div class="field">
              <label>Engine</label>
              <input id="f_engine" list="dlEngines" placeholder="Ex: 5.7 Hemi, 3.5 EcoBoost" />
            </div>

            <div class="field">
              <label>Price (USD) *</label>
              <input id="f_price" inputmode="decimal" placeholder="Ex: 799.99" />
            </div>

            <div class="field full">
              <label>Interchange</label>
              <input id="f_interchange" placeholder="Ex: Part #, Hollander #, etc" />
            </div>

            <div class="field">
              <label>Stock / Tag ID</label>
              <input id="f_stock" placeholder="Ex: BEE-01821" />
            </div>

            <div class="field">
              <label>Location</label>
              <input id="f_location" list="dlLocations" placeholder="Ex: Row 3 / Shelf B / Car #12" />
            </div>

            <div class="field full">
              <label>Notes</label>
              <textarea id="f_notes" placeholder="Ex: Tested good. Minor scratches. Include harness."></textarea>
            </div>
          </form>

          <div class="muted" style="font-size:12px; margin-top:10px;">
            * Required fields ‚Ä¢ Saves to Firestore (shared)
          </div>
        </div>
      </div>

      <div class="footer" id="adminFooter" style="display:none;">
        <div class="footer-left">
          <button class="btn" id="btnResetForm" type="button">Reset</button>
          <button class="btn danger" id="btnDelete" type="button" style="display:none;">Delete</button>
        </div>
        <div class="footer-right">
          <button class="btn primary" id="btnSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVumo8QP3m18p33ugqx_eNADsjHG0gJS0",
      authDomain: "two-little-bees-inventory.firebaseapp.com",
      projectId: "two-little-bees-inventory",
      storageBucket: "two-little-bees-inventory.firebasestorage.app",
      messagingSenderId: "669354511397",
      appId: "1:669354511397:web:a5e4565496e097f85483cc",
      measurementId: "G-736B95M78E"
    };

    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.style.display="none", 3000);
    }
    window.addEventListener("error", (e)=> toast("JS Error: " + (e.message || "unknown")));
    window.addEventListener("unhandledrejection", (e)=> toast("Promise Error: " + (e.reason?.message || e.reason || "unknown")));

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeText(s){ return String(s ?? "").toLowerCase().trim(); }
    function toMillis(ts){
      if(!ts) return 0;
      if(typeof ts === "object" && typeof ts.seconds === "number") return ts.seconds * 1000;
      if(typeof ts === "number") return ts;
      return 0;
    }
    function money(n){
      const v = Number(n);
      if(!isFinite(v)) return "‚Äî";
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }
    function setStatus(mode, text){
      const pill = $("statusPill");
      pill.classList.remove("live","err","admin");
      pill.classList.add(mode);
      $("statusText").textContent = text;
    }
    function condBadge(condition){
      const c = (condition || "Used").toLowerCase();
      let cls = "warn", label = condition || "Used";
      if(c === "new") cls = "ok";
      if(c === "used") cls = "warn";
      if(c === "reman") cls = "ok";
      if(c === "core") cls = "danger";
      return `<span class="badge"><span class="bdot ${cls}"></span>${escapeHtml(label)}</span>`;
    }

    // ---------- presets (automation) ----------
    const CATEGORY_PRESETS = [
      "Engine","Transmission","Drivetrain","Differential","Transfer Case",
      "Electrical","Lighting","Body Panels","Body Parts","Interior","Suspension",
      "Brakes","Cooling","AC/Heat","Wheels","Tires","Exhaust","Fuel System",
      "Sensors/Modules","Glass","Mirrors","Doors/Tailgate","Radiator Support","Other"
    ];
    const WARRANTY_PRESETS = [
      "No warranty",
      "7-day check warranty",
      "14-day warranty ‚Ä¢ exchange only",
      "30-day start-up warranty ‚Ä¢ exchange only",
      "60-day warranty ‚Ä¢ exchange only",
      "90-day warranty ‚Ä¢ exchange only"
    ];
    const PARTNAME_PRESETS = [
      "Engine","Transmission","Alternator","Starter","AC Compressor","Radiator",
      "Condenser","Headlight (Left)","Headlight (Right)","Tail Light (Left)","Tail Light (Right)",
      "Mirror (Left)","Mirror (Right)","Bumper (Front)","Bumper (Rear)","Hood","Fender (Left)","Fender (Right)",
      "Door (Left Front)","Door (Right Front)","Door (Left Rear)","Door (Right Rear)",
      "Wheel (Alloy)","Wheel (Steel)","Battery (Used)","Battery (New)","Rear Axle","Front Differential",
      "ECM/PCM","TCM","ABS Module","Instrument Cluster","Seats"
    ];
    const MAKE_PRESETS = ["Chevrolet","GMC","Ford","Ram","Dodge","Jeep","Chrysler","Toyota","Honda","Nissan","Hyundai","Kia","BMW","Mercedes-Benz","Audi","Volkswagen","Subaru","Mazda"];
    const ENGINE_PRESETS = ["5.7 Hemi","6.4 Hemi","3.6 Pentastar","5.3 V8","6.2 V8","6.0 V8","3.5 EcoBoost","2.7 EcoBoost","2.4","2.0T","1.8","4.7","5.0"];

    function fillSelect(id, options){
      const sel = $(id);
      sel.innerHTML = "";
      for(const v of options){
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      }
    }
    function fillDatalist(id, options){
      const dl = $(id);
      dl.innerHTML = "";
      for(const v of options){
        const o = document.createElement("option");
        o.value = v;
        dl.appendChild(o);
      }
    }

    function fitmentText(p){
      const y = String(p.vehicleYear ?? "").trim();
      const mk = String(p.vehicleMake ?? "").trim();
      const md = String(p.vehicleModel ?? "").trim();
      const tr = String(p.vehicleTrim ?? "").trim();
      const en = String(p.vehicleEngine ?? "").trim();

      const main = [y, mk, md].filter(Boolean).join(" ");
      const extra = [tr, en].filter(Boolean).join(" ‚Ä¢ ");
      if(main && extra) return `${main} ‚Ä¢ ${extra}`;
      return main || extra || "‚Äî";
    }

    // ---------- app state ----------
    const SHOP_PHONE = "13172437777";
    const SHOP_EMAIL = "twolittlebeesautoparts@gmail.com";

    let parts = [];
    let editingId = null;
    let page = 1;
    let pageSize = 25;

    // ---------- init after DOM loads ----------
    window.addEventListener("DOMContentLoaded", async ()=>{
      // If you click Admin and nothing happens, THIS line ensures it's bound:
      $("btnAdmin").addEventListener("click", ()=> openModal());

      // Preset UI
      fillSelect("f_category", CATEGORY_PRESETS);
      fillSelect("f_warranty", WARRANTY_PRESETS);
      fillDatalist("dlPartNames", PARTNAME_PRESETS);
      fillDatalist("dlMakes", MAKE_PRESETS);
      fillDatalist("dlEngines", ENGINE_PRESETS);

      // Firebase start
      let db, auth;
      try{
        const app = initializeApp(firebaseConfig);
        try { getAnalytics(app); } catch(e){}
        db = getFirestore(app);
        auth = getAuth(app);
      }catch(e){
        setStatus("err","Firebase init failed");
        toast("Firebase init failed. Check config / blocked imports.");
        console.error(e);
        return;
      }

      const isAuthed = ()=> !!auth.currentUser;

      function setAuthUI(){
        const pill = $("authPill");
        if(isAuthed()){
          pill.classList.add("admin");
          $("authText").textContent = "Admin mode";
          $("btnLogoutTop").style.display = "inline-flex";
        } else {
          pill.classList.remove("admin");
          $("authText").textContent = "Public view";
          $("btnLogoutTop").style.display = "none";
        }
      }

      function openModal(){
        $("modalBackdrop").style.display = "flex";
        if(isAuthed()){
          $("adminLogin").style.display = "none";
          $("adminPanel").style.display = "block";
          $("adminFooter").style.display = "flex";
        }else{
          $("adminLogin").style.display = "block";
          $("adminPanel").style.display = "none";
          $("adminFooter").style.display = "none";
          $("loginEmail").focus();
        }
      }
      function closeModal(){ $("modalBackdrop").style.display = "none"; }

      function resetForm(){
        editingId = null;
        $("modalTitle").textContent = "Admin ‚Äî Add Part";
        $("f_name").value = "";
        $("f_category").value = CATEGORY_PRESETS[0];
        $("f_condition").value = "Used";
        $("f_warranty").value = WARRANTY_PRESETS[2] || WARRANTY_PRESETS[0];

        $("f_year").value = "";
        $("f_make").value = "";
        $("f_model").value = "";
        $("f_trim").value = "";
        $("f_engine").value = "";

        $("f_price").value = "";
        $("f_interchange").value = "";
        $("f_stock").value = "";
        $("f_location").value = "";
        $("f_notes").value = "";

        $("btnDelete").style.display = "none";
      }

      function openEditor(id){
        const p = parts.find(x=>x.id===id);
        if(!p){ toast("Part not found."); return; }
        openModal();
        $("adminLogin").style.display = "none";
        $("adminPanel").style.display = "block";
        $("adminFooter").style.display = "flex";

        editingId = id;
        $("modalTitle").textContent = "Admin ‚Äî Edit Part";

        $("f_name").value = p.name || "";
        $("f_category").value = p.category || CATEGORY_PRESETS[0];
        $("f_condition").value = p.condition || "Used";
        $("f_warranty").value = p.warranty || WARRANTY_PRESETS[0];

        $("f_year").value = String(p.vehicleYear ?? "");
        $("f_make").value = p.vehicleMake || "";
        $("f_model").value = p.vehicleModel || "";
        $("f_trim").value = p.vehicleTrim || "";
        $("f_engine").value = p.vehicleEngine || "";

        $("f_price").value = String(p.price ?? "");
        $("f_interchange").value = p.interchange || "";
        $("f_stock").value = p.stock || "";
        $("f_location").value = p.location || "";
        $("f_notes").value = p.notes || "";

        $("btnDelete").style.display = "inline-flex";
      }

      function validateForm(){
        const name = $("f_name").value.trim();
        const category = $("f_category").value.trim();
        const price = Number(($("f_price").value || "").trim());
        if(!name) return { ok:false, msg:"Part Name is required." };
        if(!category) return { ok:false, msg:"Category is required." };
        if(!isFinite(price) || price < 0) return { ok:false, msg:"Price must be a valid number." };
        return { ok:true, price };
      }

      async function saveFromForm(){
        if(!isAuthed()){ toast("Log in first."); return; }
        const v = validateForm();
        if(!v.ok){ toast(v.msg); return; }

        const payload = {
          name: $("f_name").value.trim(),
          category: $("f_category").value.trim(),
          condition: $("f_condition").value,
          warranty: $("f_warranty").value,

          vehicleYear: String(($("f_year").value || "").trim()),
          vehicleMake: $("f_make").value.trim(),
          vehicleModel: $("f_model").value.trim(),
          vehicleTrim: $("f_trim").value.trim(),
          vehicleEngine: $("f_engine").value.trim(),

          price: v.price,
          interchange: $("f_interchange").value.trim(),
          stock: $("f_stock").value.trim(),
          location: $("f_location").value.trim(),
          notes: $("f_notes").value.trim(),
          updatedAt: serverTimestamp()
        };

        try{
          if(editingId){
            await updateDoc(doc(db, "parts", editingId), payload);
            toast("Saved changes.");
          } else {
            await addDoc(collection(db, "parts"), { ...payload, createdAt: serverTimestamp() });
            toast("Part added.");
          }
          closeModal();
        }catch(e){
          console.error(e);
          toast("Save failed. Check Firestore rules (write needs auth).");
        }
      }

      async function deleteEditing(){
        if(!isAuthed()){ toast("Log in first."); return; }
        if(!editingId) return;
        const p = parts.find(x=>x.id===editingId);
        if(!p) return;
        if(!confirm(`Delete "${p.name}"?`)) return;

        try{
          await deleteDoc(doc(db, "parts", editingId));
          toast("Part deleted.");
          closeModal();
        }catch(e){
          console.error(e);
          toast("Delete failed. Check Firestore rules.");
        }
      }

      async function doLogin(){
        const email = ($("loginEmail").value || "").trim();
        const pass  = ($("loginPass").value || "").trim();
        if(!email || !pass){ toast("Enter email + password."); return; }
        try{
          await signInWithEmailAndPassword(auth, email, pass);
          toast("Logged in.");
          openModal();
          resetForm();
          setAuthUI();
        }catch(e){
          console.error(e);
          toast("Login failed. Check email/password or Authorized Domains.");
        }
      }

      async function doLogout(){
        try{ await signOut(auth); }catch(e){}
        editingId = null;
        toast("Logged out.");
        closeModal();
        setAuthUI();
      }

      function getFiltered(){
        const qRaw = $("q").value || "";
        const q = normalizeText(qRaw);
        const cat = $("cat").value;
        const cond = $("cond").value;

        let out = parts.slice();
        if(cat) out = out.filter(p => p.category === cat);
        if(cond) out = out.filter(p => (p.condition || "") === cond);

        if(q){
          out = out.filter(p=>{
            const hay = [
              p.name, p.category, p.condition, p.warranty, p.interchange, p.stock, p.location, p.notes,
              p.vehicleYear, p.vehicleMake, p.vehicleModel, p.vehicleTrim, p.vehicleEngine,
              String(p.price ?? "")
            ].join(" ").toLowerCase();
            return hay.includes(q);
          });
        }

        const sort = $("sort").value;
        if(sort === "priceAsc") out.sort((a,b)=>(Number(a.price)||0)-(Number(b.price)||0));
        if(sort === "priceDesc") out.sort((a,b)=>(Number(b.price)||0)-(Number(a.price)||0));
        if(sort === "nameAsc") out.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        if(sort === "newest") out.sort((a,b)=>{
          const aa = Math.max(toMillis(a.createdAt), toMillis(a.updatedAt));
          const bb = Math.max(toMillis(b.createdAt), toMillis(b.updatedAt));
          return bb - aa;
        });

        return { list: out, qRaw };
      }

      function paginate(list){
        const total = list.length;
        const pages = Math.max(1, Math.ceil(total / pageSize));
        page = Math.min(Math.max(1, page), pages);
        const startIdx = (page - 1) * pageSize;
        const endIdx = Math.min(total, startIdx + pageSize);
        return { slice: list.slice(startIdx, endIdx), total, pages, startIdx, endIdx };
      }

      function renderCategoryOptions(){
        const catSel = $("cat");
        const current = catSel.value;
        const set = new Set(parts.map(p => (p.category || "").trim()).filter(Boolean));
        const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
        catSel.innerHTML = '<option value="">All</option>';
        cats.forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          catSel.appendChild(opt);
        });
        if([...catSel.options].some(o=>o.value===current)) catSel.value = current;
      }

      function render(){
        const { list } = getFiltered();
        const { slice, total, pages, startIdx, endIdx } = paginate(list);

        $("countPill").textContent = `${total} part${total===1?"":"s"}`;
        $("empty").style.display = total ? "none" : "block";

        $("pager").style.display = total ? "flex" : "none";
        $("pagerInfo").textContent = `Page ${page} / ${pages}`;
        $("rangeInfo").textContent = total ? `Showing ${startIdx+1}-${endIdx} of ${total}` : "‚Äî";

        const tbody = $("tbody");
        tbody.innerHTML = "";

        for(const p of slice){
          const askMsg = encodeURIComponent(
            `Hi! I‚Äôm interested in this part:\n\n`+
            `Part: ${p.name}\n`+
            `Category: ${p.category}\n`+
            `Condition: ${p.condition}\n`+
            `Vehicle: ${fitmentText(p)}\n`+
            `Price: ${money(p.price)}\n`+
            `Warranty: ${p.warranty}\n`+
            `Interchange: ${p.interchange}\n`+
            `Stock/Tag: ${p.stock}\n`+
            `Location: ${p.location}\n\n`+
            `Can you confirm availability and exact fitment?`
          );

          const emailLink = `mailto:${SHOP_EMAIL}?subject=${encodeURIComponent("Parts Inquiry ‚Äî Two Little Bees")}&body=${askMsg}`;
          const telLink = `tel:${SHOP_PHONE}`;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${escapeHtml(p.name || "‚Äî")}</b><div class="muted" style="font-size:12px;">${escapeHtml(p.stock || "No tag")} ‚Ä¢ ${escapeHtml(p.location || "No location")}</div></td>
            <td>${escapeHtml(p.category || "‚Äî")}</td>
            <td>${condBadge(p.condition)}</td>
            <td>${escapeHtml(fitmentText(p))}</td>
            <td><span class="price">${money(p.price)}</span></td>
            <td>${escapeHtml(p.warranty || "‚Äî")}</td>
            <td>${escapeHtml(p.interchange || "‚Äî")}</td>
            <td>${escapeHtml(p.notes || "‚Äî")}</td>
            <td>
              <div class="actions">
                <a class="mini primary" href="${telLink}">üìû Call</a>
                <a class="mini" href="${emailLink}">‚úâÔ∏è Email</a>
                <button class="mini" data-edit="${p.id}" type="button">‚úèÔ∏è Edit</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // Edit buttons
        tbody.querySelectorAll("button[data-edit]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-edit");
            if(!isAuthed()){
              openModal();
              toast("Log in to edit.");
              return;
            }
            openEditor(id);
          });
        });

        setAuthUI();
      }

      // UI events
      $("btnCloseModal").addEventListener("click", closeModal);
      $("btnCancelLogin").addEventListener("click", closeModal);
      $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")) closeModal(); });

      $("btnLogin").addEventListener("click", doLogin);
      $("loginPass").addEventListener("keydown", (e)=>{ if(e.key === "Enter") doLogin(); });

      $("btnLogout").addEventListener("click", doLogout);
      $("btnLogoutTop").addEventListener("click", doLogout);

      $("btnNew").addEventListener("click", ()=>{ if(!isAuthed()) return toast("Log in first."); resetForm(); $("f_name").focus(); });
      $("btnSave").addEventListener("click", saveFromForm);
      $("btnResetForm").addEventListener("click", resetForm);
      $("btnDelete").addEventListener("click", deleteEditing);

      $("btnClear").addEventListener("click", ()=>{
        $("q").value = "";
        $("cat").value = "";
        $("cond").value = "";
        $("sort").value = "newest";
        page = 1;
        render();
      });

      $("pageSize").addEventListener("change", ()=>{
        pageSize = Number($("pageSize").value) || 25;
        page = 1;
        render();
      });

      $("btnPrev").addEventListener("click", ()=>{ page = Math.max(1, page-1); render(); });
      $("btnNext").addEventListener("click", ()=>{ page = page+1; render(); });

      ["q","cat","cond","sort"].forEach(id=>{
        $(id).addEventListener(id==="q" ? "input" : "change", ()=>{ page=1; render(); });
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "/" && document.activeElement && !["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)){
          e.preventDefault();
          $("q").focus();
        }
        if(e.key === "Escape" && $("modalBackdrop").style.display === "flex"){
          closeModal();
        }
      });

      // Auth state
      onAuthStateChanged(auth, ()=> setAuthUI());

      // Realtime Firestore
      setStatus("live","Connecting‚Ä¶");
      onSnapshot(collection(db, "parts"), (snap)=>{
        parts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        parts.sort((a,b)=>{
          const aa = Math.max(toMillis(a.createdAt), toMillis(a.updatedAt));
          const bb = Math.max(toMillis(b.createdAt), toMillis(b.updatedAt));
          return bb - aa;
        });

        // ‚Äúlearned‚Äù lists
        const models = Array.from(new Set(parts.map(p=>String(p.vehicleModel||"").trim()).filter(Boolean))).sort();
        const locations = Array.from(new Set(parts.map(p=>String(p.location||"").trim()).filter(Boolean))).sort();
        fillDatalist("dlModels", models);
        fillDatalist("dlLocations", locations);

        renderCategoryOptions();
        render();
        setStatus("live","Live ‚Ä¢ Firestore");
      }, (err)=>{
        console.error(err);
        setStatus("err","Firestore error");
        toast("Firestore error. Check rules + collection name (parts).");
      });

      // Final
      resetForm();
      setAuthUI();
      render();
      toast("Loaded ‚úî");
    });
  </script>
</body>
</html>
