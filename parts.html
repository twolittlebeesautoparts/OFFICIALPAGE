<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Two Little Bees ‚Äì Parts Inventory</title>
  <meta name="description" content="Two Little Bees Auto Parts ‚Äî yard parts inventory with pricing, warranty, and interchange info." />
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0b0f14">

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --panel-soft:#0f172a;
      --card:#0e1726;

      --text:#f9fafb;
      --muted:#9ca3af;

      --accent:#f4c430;
      --accent2:#ffb703;

      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 16px;

      --max: 1100px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(244,196,48,.10), transparent 55%),
        radial-gradient(900px 500px at 90% 5%, rgba(255,183,3,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 18%),
        var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; }

    .wrap{ max-width:var(--max); margin:0 auto; padding:18px; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--border); border-radius:var(--radius);
      background:rgba(17,24,39,.70); backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(244,196,48,.95), rgba(255,183,3,.75));
      border:1px solid rgba(0,0,0,.25);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title b{
      font-size:14px; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .title span{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .navbtns{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(244,196,48,.45);
      background: linear-gradient(180deg, rgba(244,196,48,.20), rgba(255,183,3,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.45);
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }
    .pill{
      font-size:12px; color:var(--muted);
      padding:4px 10px; border:1px solid var(--border);
      border-radius:999px; background: rgba(0,0,0,.15);
    }

    .hero{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 4px);
      background: linear-gradient(180deg, rgba(17,24,39,.75), rgba(15,23,42,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero-inner{ padding:18px; }
    .hero h1{ margin:0 0 6px 0; font-size:20px; letter-spacing:.2px; }
    .hero p{ margin:0; color:var(--muted); line-height:1.35; font-size:13px; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .65fr .65fr .7fr .7fr;
      gap:10px;
      padding:14px 18px 18px 18px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    @media (max-width: 920px){
      .controls{ grid-template-columns: 1fr 1fr; }
      .controls .span2{ grid-column: span 2; }
      .controls .spanFull{ grid-column: 1 / -1; }
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select{
      width:100%;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 12px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(244,196,48,.55);
      box-shadow: 0 0 0 3px rgba(244,196,48,.10);
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }

    .card{
      grid-column: span 12;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,24,39,.65);
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .list-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.14);
      flex-wrap:wrap;
    }
    .list-head .left{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .list-head .left b{ font-size:14px; }
    .list-head .left span{ font-size:12px; color:var(--muted); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .mini{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .mini:hover{ background: rgba(255,255,255,.06); }
    .mini.primary{ border-color: rgba(244,196,48,.45); background: rgba(244,196,48,.12); }
    .mini.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }

    .tableWrap{ width:100%; overflow:auto; }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{
      text-align:left;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align: top;
      font-size:13px;
    }
    .table th{
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.10);
      position: sticky;
      top: 82px;
      z-index: 5;
    }
    @media (max-width: 920px){
      .table th{ top: 132px; }
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background: var(--muted); }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.danger{ background: var(--danger); }

    .muted{ color:var(--muted); }
    .price{ font-weight:800; letter-spacing:.2px; }
    .empty{ padding:18px; color:var(--muted); text-align:center; }

    /* Mobile cards (no side scroll) */
    .mobileList{ display:none; padding:12px; }
    .partCard{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:12px;
      margin-bottom:10px;
      box-shadow: 0 10px 28px rgba(0,0,0,.20);
    }
    .partCard .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .partCard h3{ margin:0; font-size:14px; letter-spacing:.2px; line-height:1.25; }
    .partCard .sub{ margin-top:4px; font-size:12px; color:var(--muted); }
    .partCard .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; font-size:13px; }
    .kv{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      padding:8px 10px;
      border-radius: 12px;
      min-width: 160px;
      flex:1 1 160px;
    }
    .kv b{ display:block; font-size:11px; color:var(--muted); margin-bottom:4px; font-weight:600; }
    .kv span{ display:block; }

    @media (max-width: 920px){
      .tableWrap{ display:none; }
      .mobileList{ display:block; }
    }

    /* Pagination */
    .pager{
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .pager .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pager .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width:min(860px, 100%);
      border-radius: 18px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.92);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.14);
    }
    .modal header b{ font-size:14px; }
    .modal header .x{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      color:var(--text);
      user-select:none;
    }
    .modal header .x:hover{ background: rgba(255,255,255,.06); }

    .modal .body{ padding:14px 16px 16px 16px; }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .form .full{ grid-column: 1 / -1; }
    @media (max-width: 720px){ .form{ grid-template-columns: 1fr; } }

    textarea{
      width:100%;
      min-height:84px;
      resize:vertical;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      color: var(--text);
      padding:11px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(244,196,48,.55);
      box-shadow: 0 0 0 3px rgba(244,196,48,.10);
    }

    .modal .footer{
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:12px 16px 16px 16px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .footer-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .footer-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.70);
      border:1px solid var(--border);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      display:none;
      z-index: 99;
      max-width: min(720px, calc(100% - 24px));
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      font-size:13px;
    }

    .footer-note{
      margin: 14px 0 26px 0;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-bottom-color: rgba(0,0,0,.35);
      border-radius: 8px;
      background: rgba(0,0,0,.18);
      color: var(--text);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" title="Two Little Bees Auto Parts">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Two Little Bees ‚Äî Parts Inventory</b>
          <span>Warranty ‚Ä¢ Price ‚Ä¢ Interchanges ‚Ä¢ Yard info</span>
        </div>
      </div>

      <div class="navbtns">
        <a class="btn" href="index.html" title="Back to landing">‚¨ÖÔ∏è Landing</a>
        <a class="btn" href="https://twolittlebeesautoparts.github.io/" title="Back to car inventory">üöó Cars</a>
        <button class="btn primary" id="btnAdmin">üîí Admin</button>
        <button class="btn danger" id="btnLogoutTop" style="display:none;">üö™ Logout</button>
        <span class="pill" id="countPill">0 parts</span>
      </div>
    </div>

    <section class="hero" aria-label="Parts Search">
      <div class="hero-inner">
        <h1>Find Parts Fast</h1>
        <p>Search by part name, vehicle, notes, stock ID, or interchange. Public can view ‚Äî admin can edit.</p>
      </div>

      <div class="controls">
        <div class="field span2">
          <label for="q">Search</label>
          <input id="q" type="text" placeholder="Example: 5.7 Hemi, alternator, mirror, 2014 Silverado, LKQ, 560-..." autocomplete="off" />
        </div>

        <div class="field">
          <label for="cat">Category</label>
          <select id="cat">
            <option value="">All</option>
          </select>
        </div>

        <div class="field">
          <label for="cond">Condition</label>
          <select id="cond">
            <option value="">All</option>
            <option>Used</option>
            <option>New</option>
            <option>Reman</option>
            <option>Core</option>
          </select>
        </div>

        <div class="field">
          <label for="sort">Sort</label>
          <select id="sort">
            <option value="newest">Newest</option>
            <option value="priceAsc">Price (Low ‚Üí High)</option>
            <option value="priceDesc">Price (High ‚Üí Low)</option>
            <option value="nameAsc">Name (A ‚Üí Z)</option>
          </select>
        </div>

        <div class="field">
          <label for="pageSize">Per Page</label>
          <select id="pageSize">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <div class="field spanFull">
          <label>&nbsp;</label>
          <button class="btn" id="btnClear">üßπ Clear filters</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="card">
        <div class="list-head">
          <div class="left">
            <b>Available Parts</b>
            <span class="muted">Tip: press <span class="kbd">/</span> to jump to search ‚Ä¢ Realtime database.</span>
          </div>
          <div class="actions">
            <span class="pill" id="authPill">Public view</span>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table" id="partsTable">
            <thead>
              <tr>
                <th style="min-width:170px;">Part</th>
                <th style="min-width:120px;">Category</th>
                <th style="min-width:110px;">Condition</th>
                <th style="min-width:120px;">Price</th>
                <th style="min-width:200px;">Warranty</th>
                <th style="min-width:240px;">Interchange</th>
                <th style="min-width:170px;">Yard / Notes</th>
                <th style="min-width:190px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="mobileList" id="mobileList"></div>

        <div class="empty" id="empty" style="display:none;">No parts match your search.</div>

        <div class="pager" id="pager" style="display:none;">
          <div class="left">
            <span class="pill" id="pagerInfo">Page 1</span>
            <span class="muted" id="rangeInfo" style="font-size:12px;">‚Äî</span>
          </div>
          <div class="right">
            <button class="mini" id="btnPrev">‚¨ÖÔ∏è Prev</button>
            <button class="mini" id="btnNext">Next ‚û°Ô∏è</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-note">
      Hablamos Espa√±ol ‚Ä¢ Call: <b>(317) 243-7777</b> ‚Ä¢ 507 S Tibbs Ave, Indianapolis
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Admin Panel">
    <div class="modal">
      <header>
        <b id="modalTitle">Admin</b>
        <button class="x" id="btnCloseModal" aria-label="Close">‚úï</button>
      </header>

      <div class="body">
        <!-- LOGIN -->
        <div id="adminLogin">
          <div class="form" style="margin-top:6px;">
            <div class="field">
              <label>Username</label>
              <input id="u" placeholder="admin" autocomplete="off" />
            </div>
            <div class="field">
              <label>Password</label>
              <input id="pw" type="password" placeholder="bees123" autocomplete="off" />
            </div>
            <div class="field full">
              <label>PIN</label>
              <input id="pin" type="password" inputmode="numeric" placeholder="1520" autocomplete="off" />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn primary" id="btnUnlock">Log In</button>
            <button class="btn" id="btnCancelUnlock">Cancel</button>
          </div>

          <p class="muted" style="margin:10px 0 0 0; font-size:12px;">
            Admin edits are protected by Firebase Auth + Firestore rules.
          </p>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
            <span class="badge"><span class="dot ok"></span> Admin logged in</span>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="mini" id="btnNew">‚ûï Add new part</button>
              <button class="mini danger" id="btnLogout">üö™ Logout</button>
            </div>
          </div>

          <form class="form" id="partForm" onsubmit="return false;">
            <div class="field">
              <label>Part Name *</label>
              <input id="f_name" placeholder="Ex: Engine 5.7 Hemi" />
            </div>

            <div class="field">
              <label>Category *</label>
              <input id="f_category" placeholder="Ex: Engine, Transmission, Body, Electrical..." />
            </div>

            <div class="field">
              <label>Condition</label>
              <select id="f_condition">
                <option>Used</option>
                <option>New</option>
                <option>Reman</option>
                <option>Core</option>
              </select>
            </div>

            <div class="field">
              <label>Price (USD) *</label>
              <input id="f_price" inputmode="decimal" placeholder="Ex: 799.99" />
            </div>

            <div class="field full">
              <label>Warranty</label>
              <input id="f_warranty" placeholder="Ex: 30-day start-up warranty ‚Ä¢ exchange only" />
            </div>

            <div class="field full">
              <label>Interchange</label>
              <input id="f_interchange" placeholder="Ex: Fits 2014‚Äì2019 Ram 1500 5.7 ‚Ä¢ P/N 1234AB ‚Ä¢ Hollander 300-12345" />
            </div>

            <div class="field">
              <label>Stock / Tag ID</label>
              <input id="f_stock" placeholder="Ex: BEE-01821" />
            </div>

            <div class="field">
              <label>Location</label>
              <input id="f_location" placeholder="Ex: Row 3 / Shelf B / Car #12" />
            </div>

            <div class="field full">
              <label>Notes</label>
              <textarea id="f_notes" placeholder="Ex: Tested good. Minor scratches. Include harness."></textarea>
            </div>
          </form>

          <div class="muted" style="font-size:12px; margin-top:10px;">
            * Required fields ‚Ä¢ Saves to Firestore (shared)
          </div>
        </div>
      </div>

      <div class="footer" id="adminFooter" style="display:none;">
        <div class="footer-left">
          <button class="btn" id="btnResetForm">Reset</button>
          <button class="btn danger" id="btnDelete" style="display:none;">Delete</button>
        </div>
        <div class="footer-right">
          <button class="btn primary" id="btnSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase + App -->
  <script type="module">
    /**********************
     * YOUR FIREBASE CONFIG (from you)
     **********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVumo8QP3m18p33ugqx_eNADsjHG0gJS0",
      authDomain: "two-little-bees-inventory.firebaseapp.com",
      projectId: "two-little-bees-inventory",
      storageBucket: "two-little-bees-inventory.firebasestorage.app",
      messagingSenderId: "669354511397",
      appId: "1:669354511397:web:a5e4565496e097f85483cc",
      measurementId: "G-736B95M78E"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){}

    const db = getFirestore(app);
    const auth = getAuth(app);

    /**********************
     * CONFIG
     **********************/
    const SHOP_PHONE = "13172437777";
    const SHOP_EMAIL = "twolittlebeesautoparts@gmail.com";

    // Your requested admin login
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "bees123";
    const ADMIN_PIN  = "1520";

    // Behind the scenes Firebase Auth uses email+password
    // Create this user in Firebase Auth:
    // Email: admin@tlb.local
    // Pass:  bees123
    const ADMIN_EMAIL = "admin@tlb.local";

    const ADMIN_IDLE_LOCK_MS = 10 * 60 * 1000; // 10 minutes

    /**********************
     * UTIL
     **********************/
    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n);
      if (!isFinite(v)) return "‚Äî";
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.style.display="none", 2600);
    }

    function debounce(fn, ms){
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    function normalizeText(s){
      return String(s ?? "").toLowerCase().trim();
    }

    function markQuery(text, q){
      const raw = String(text ?? "");
      const query = String(q ?? "").trim();
      if(!query) return escapeHtml(raw);
      const safe = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(safe, "ig");
      return escapeHtml(raw).replace(re, (m)=>`<mark style="background:rgba(244,196,48,.18); padding:0 2px; border-radius:6px;">${escapeHtml(m)}</mark>`);
    }

    /**********************
     * STATE
     **********************/
    let parts = [];
    let adminUnlocked = false; // requires auth + pin verified
    let editingId = null;

    let page = 1;
    let pageSize = 25;

    let lastAdminActivity = 0;
    function touchAdmin(){ if(adminUnlocked) lastAdminActivity = Date.now(); }

    function isAuthed(){
      return !!auth.currentUser;
    }

    function setAuthUI(){
      const authed = isAuthed() && adminUnlocked;
      $("authPill").textContent = authed ? "Admin mode" : "Public view";
      $("btnLogoutTop").style.display = authed ? "inline-flex" : "none";
    }

    /**********************
     * FIRESTORE SUBSCRIBE (Realtime)
     **********************/
    const partsCol = collection(db, "parts");
    const partsQ = query(partsCol, orderBy("createdAt", "desc"));

    onSnapshot(partsQ, (snap)=>{
      parts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderCategoryOptions();
      render();
    }, (err)=>{
      console.error(err);
      toast("Firestore read blocked. Check rules / Firestore setup.");
    });

    /**********************
     * FILTERING + PAGINATION
     **********************/
    function uniqueCategories(items){
      const set = new Set(items.map(p => (p.category || "").trim()).filter(Boolean));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function renderCategoryOptions(){
      const catSel = $("cat");
      const current = catSel.value;
      catSel.innerHTML = '<option value="">All</option>';
      uniqueCategories(parts).forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        catSel.appendChild(opt);
      });
      if([...catSel.options].some(o=>o.value===current)) catSel.value = current;
    }

    function getFiltered(){
      const qRaw = $("q").value || "";
      const q = normalizeText(qRaw);
      const cat = $("cat").value;
      const cond = $("cond").value;

      let out = parts.slice();

      if(cat) out = out.filter(p => p.category === cat);
      if(cond) out = out.filter(p => (p.condition || "") === cond);

      if(q){
        out = out.filter(p=>{
          const hay = [
            p.name, p.category, p.condition, p.warranty, p.interchange, p.stock, p.location, p.notes,
            String(p.price ?? "")
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      const sort = $("sort").value;
      if(sort === "priceAsc") out.sort((a,b)=>(Number(a.price)||0)-(Number(b.price)||0));
      if(sort === "priceDesc") out.sort((a,b)=>(Number(b.price)||0)-(Number(a.price)||0));
      if(sort === "nameAsc") out.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      if(sort === "newest") out.sort((a,b)=>{
        const aa = (a.createdAt?.seconds ? a.createdAt.seconds*1000 : Number(a.createdAt||0));
        const bb = (b.createdAt?.seconds ? b.createdAt.seconds*1000 : Number(b.createdAt||0));
        return bb - aa;
      });

      return { list: out, qRaw };
    }

    function paginate(list){
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1, page), pages);

      const startIdx = (page - 1) * pageSize;
      const endIdx = Math.min(total, startIdx + pageSize);
      const slice = list.slice(startIdx, endIdx);
      return { slice, total, pages, startIdx, endIdx };
    }

    function condBadge(condition){
      const c = (condition || "Used").toLowerCase();
      let cls = "warn", label = condition || "Used";
      if(c === "new") cls = "ok";
      if(c === "used") cls = "warn";
      if(c === "reman") cls = "ok";
      if(c === "core") cls = "danger";
      return `<span class="badge"><span class="dot ${cls}"></span>${escapeHtml(label)}</span>`;
    }

    /**********************
     * RENDER
     **********************/
    function render(){
      const { list, qRaw } = getFiltered();
      const { slice, total, pages, startIdx, endIdx } = paginate(list);

      $("countPill").textContent = `${total} part${total===1?"":"s"}`;
      $("empty").style.display = total ? "none" : "block";

      $("pager").style.display = total ? "flex" : "none";
      $("pagerInfo").textContent = `Page ${page} / ${pages}`;
      $("rangeInfo").textContent = total ? `Showing ${startIdx+1}-${endIdx} of ${total}` : "‚Äî";

      const tbody = $("tbody");
      tbody.innerHTML = "";

      for(const p of slice){
        const askMsg = encodeURIComponent(
          `Hi! I‚Äôm interested in this part:\n\n`+
          `Part: ${p.name}\n`+
          `Category: ${p.category}\n`+
          `Condition: ${p.condition}\n`+
          `Price: ${money(p.price)}\n`+
          `Warranty: ${p.warranty}\n`+
          `Interchange: ${p.interchange}\n`+
          `Stock/Tag: ${p.stock}\n`+
          `Location: ${p.location}\n\n`+
          `Can you confirm availability and exact fitment?`
        );

        const emailLink = `mailto:${SHOP_EMAIL}?subject=${encodeURIComponent("Parts Inquiry ‚Äî Two Little Bees")}&body=${askMsg}`;
        const telLink = `tel:${SHOP_PHONE}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <b style="font-size:13px; letter-spacing:.2px;">${markQuery(p.name, qRaw)}</b>
              <span class="muted" style="font-size:12px;">${markQuery(p.stock || "No tag", qRaw)} ‚Ä¢ ${markQuery(p.location || "No location", qRaw)}</span>
            </div>
          </td>
          <td>${markQuery(p.category || "‚Äî", qRaw)}</td>
          <td>${condBadge(p.condition)}</td>
          <td><span class="price">${money(p.price)}</span></td>
          <td>${markQuery(p.warranty || "‚Äî", qRaw)}</td>
          <td>${markQuery(p.interchange || "‚Äî", qRaw)}</td>
          <td>${markQuery(p.notes || "‚Äî", qRaw)}</td>
          <td>
            <div class="actions">
              <a class="mini primary" href="${telLink}" title="Call about this part">üìû Call</a>
              <a class="mini" href="${emailLink}" title="Email details">‚úâÔ∏è Email</a>
              <button class="mini" data-edit="${p.id}" title="Edit (admin)">‚úèÔ∏è Edit</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Mobile cards
      const mobile = $("mobileList");
      mobile.innerHTML = "";
      for(const p of slice){
        const askMsg = encodeURIComponent(
          `Hi! I‚Äôm interested in this part:\n\n`+
          `Part: ${p.name}\n`+
          `Category: ${p.category}\n`+
          `Condition: ${p.condition}\n`+
          `Price: ${money(p.price)}\n`+
          `Warranty: ${p.warranty}\n`+
          `Interchange: ${p.interchange}\n`+
          `Stock/Tag: ${p.stock}\n`+
          `Location: ${p.location}\n\n`+
          `Can you confirm availability and exact fitment?`
        );

        const emailLink = `mailto:${SHOP_EMAIL}?subject=${encodeURIComponent("Parts Inquiry ‚Äî Two Little Bees")}&body=${askMsg}`;
        const telLink = `tel:${SHOP_PHONE}`;

        const div = document.createElement("div");
        div.className = "partCard";
        div.innerHTML = `
          <div class="top">
            <div>
              <h3>${markQuery(p.name, qRaw)}</h3>
              <div class="sub">${markQuery(p.stock || "No tag", qRaw)} ‚Ä¢ ${markQuery(p.location || "No location", qRaw)}</div>
            </div>
            <div>${condBadge(p.condition)}</div>
          </div>

          <div class="row">
            <div class="kv"><b>Category</b><span>${markQuery(p.category || "‚Äî", qRaw)}</span></div>
            <div class="kv"><b>Price</b><span class="price">${money(p.price)}</span></div>
            <div class="kv"><b>Warranty</b><span>${markQuery(p.warranty || "‚Äî", qRaw)}</span></div>
            <div class="kv"><b>Interchange</b><span>${markQuery(p.interchange || "‚Äî", qRaw)}</span></div>
            <div class="kv"><b>Notes</b><span>${markQuery(p.notes || "‚Äî", qRaw)}</span></div>
          </div>

          <div class="actions" style="margin-top:10px;">
            <a class="mini primary" href="${telLink}">üìû Call</a>
            <a class="mini" href="${emailLink}">‚úâÔ∏è Email</a>
            <button class="mini" data-edit="${p.id}">‚úèÔ∏è Edit</button>
          </div>
        `;
        mobile.appendChild(div);
      }

      // Wire edit buttons
      [...document.querySelectorAll("button[data-edit]")].forEach(btn=>{
        btn.onclick = () => {
          const id = btn.getAttribute("data-edit");
          if(!isAuthed() || !adminUnlocked){
            openModal();
            toast("Admin locked ‚Äî log in to edit.");
            return;
          }
          touchAdmin();
          openEditor(id);
        };
      });

      setAuthUI();
    }

    /**********************
     * ADMIN MODAL + CRUD (Firestore)
     **********************/
    function openModal(){
      $("modalBackdrop").style.display = "flex";
      if(isAuthed() && adminUnlocked){
        $("adminLogin").style.display = "none";
        $("adminPanel").style.display = "block";
        $("adminFooter").style.display = "flex";
        touchAdmin();
      } else {
        $("adminLogin").style.display = "block";
        $("adminPanel").style.display = "none";
        $("adminFooter").style.display = "none";
        $("u").value = "";
        $("pw").value = "";
        $("pin").value = "";
        $("u").focus();
      }
    }

    function closeModal(){
      $("modalBackdrop").style.display = "none";
    }

    function resetForm(){
      editingId = null;
      $("modalTitle").textContent = "Admin ‚Äî Add Part";
      $("f_name").value = "";
      $("f_category").value = "";
      $("f_condition").value = "Used";
      $("f_price").value = "";
      $("f_warranty").value = "";
      $("f_interchange").value = "";
      $("f_stock").value = "";
      $("f_location").value = "";
      $("f_notes").value = "";
      $("btnDelete").style.display = "none";
    }

    function openEditor(id){
      const p = parts.find(x=>x.id===id);
      if(!p){ toast("Part not found."); return; }
      openModal();

      $("adminLogin").style.display = "none";
      $("adminPanel").style.display = "block";
      $("adminFooter").style.display = "flex";

      editingId = id;
      $("modalTitle").textContent = "Admin ‚Äî Edit Part";
      $("f_name").value = p.name || "";
      $("f_category").value = p.category || "";
      $("f_condition").value = p.condition || "Used";
      $("f_price").value = String(p.price ?? "");
      $("f_warranty").value = p.warranty || "";
      $("f_interchange").value = p.interchange || "";
      $("f_stock").value = p.stock || "";
      $("f_location").value = p.location || "";
      $("f_notes").value = p.notes || "";
      $("btnDelete").style.display = "inline-flex";
    }

    function validateForm(){
      const name = $("f_name").value.trim();
      const category = $("f_category").value.trim();
      const price = Number(($("f_price").value || "").trim());
      if(!name) return { ok:false, msg:"Part Name is required." };
      if(!category) return { ok:false, msg:"Category is required." };
      if(!isFinite(price) || price < 0) return { ok:false, msg:"Price must be a valid number." };
      return { ok:true, price, name, category };
    }

    async function saveFromForm(){
      if(!isAuthed() || !adminUnlocked){ toast("Admin locked."); return; }
      touchAdmin();

      const v = validateForm();
      if(!v.ok){ toast(v.msg); return; }

      const payload = {
        name: $("f_name").value.trim(),
        category: $("f_category").value.trim(),
        condition: $("f_condition").value,
        price: v.price,
        warranty: $("f_warranty").value.trim(),
        interchange: $("f_interchange").value.trim(),
        stock: $("f_stock").value.trim(),
        location: $("f_location").value.trim(),
        notes: $("f_notes").value.trim(),
        updatedAt: serverTimestamp()
      };

      try{
        if(editingId){
          await updateDoc(doc(db, "parts", editingId), payload);
          toast("Saved changes.");
        } else {
          await addDoc(collection(db, "parts"), {
            ...payload,
            createdAt: serverTimestamp()
          });
          toast("Part added.");
        }
        closeModal();
      }catch(e){
        console.error(e);
        toast("Save failed. Check Firestore rules / auth.");
      }
    }

    async function deleteEditing(){
      if(!isAuthed() || !adminUnlocked){ toast("Admin locked."); return; }
      touchAdmin();

      if(!editingId) return;
      const p = parts.find(x=>x.id===editingId);
      if(!p) return;

      const yes = confirm(`Delete "${p.name}"?`);
      if(!yes) return;

      try{
        await deleteDoc(doc(db, "parts", editingId));
        toast("Part deleted.");
        closeModal();
      }catch(e){
        console.error(e);
        toast("Delete failed. Check Firestore rules / auth.");
      }
    }

    /**********************
     * AUTH (Login/Logout)
     **********************/
    async function doLogin(){
      const u = ($("u").value || "").trim();
      const pw = ($("pw").value || "").trim();
      const pin = ($("pin").value || "").trim();

      // UI credentials check (so random people can‚Äôt even try)
      if(u !== ADMIN_USER || pw !== ADMIN_PASS || pin !== ADMIN_PIN){
        toast("Wrong login.");
        return;
      }

      try{
        // Real Firebase login:
        await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASS);
        adminUnlocked = true; // pin verified
        lastAdminActivity = Date.now();
        toast("Admin logged in.");
        openModal();
        resetForm();
        setAuthUI();
      }catch(e){
        console.error(e);
        toast("Firebase login failed. Make sure admin@tlb.local exists in Auth.");
      }
    }

    async function doLogout(){
      try{
        await signOut(auth);
      }catch(e){}
      adminUnlocked = false;
      editingId = null;
      toast("Logged out.");
      closeModal();
      setAuthUI();
    }

    function adminAutoLockTick(){
      if(!adminUnlocked) return;
      const now = Date.now();
      if(now - lastAdminActivity > ADMIN_IDLE_LOCK_MS){
        adminUnlocked = false;
        editingId = null;
        toast("Admin auto-logged out (inactive).");
        closeModal();
        setAuthUI();
      }
    }

    onAuthStateChanged(auth, (user)=>{
      if(!user){
        adminUnlocked = false;
        editingId = null;
      }
      setAuthUI();
    });

    /**********************
     * EVENTS
     **********************/
    function wire(){
      window.addEventListener("keydown", (e)=>{
        if(e.key === "/" && document.activeElement && !["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)){
          e.preventDefault();
          $("q").focus();
        }
        if(e.key === "Escape" && $("modalBackdrop").style.display === "flex"){
          closeModal();
        }
      });

      const debouncedRender = debounce(()=>{ page = 1; render(); }, 120);
      $("q").addEventListener("input", debouncedRender);
      $("cat").addEventListener("change", ()=>{ page = 1; render(); });
      $("cond").addEventListener("change", ()=>{ page = 1; render(); });
      $("sort").addEventListener("change", ()=>{ page = 1; render(); });

      $("pageSize").addEventListener("change", ()=>{
        pageSize = Number($("pageSize").value) || 25;
        page = 1;
        render();
      });

      $("btnPrev").addEventListener("click", ()=>{
        page = Math.max(1, page - 1);
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      $("btnNext").addEventListener("click", ()=>{
        page = page + 1;
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      $("btnClear").addEventListener("click", ()=>{
        $("q").value = "";
        $("cat").value = "";
        $("cond").value = "";
        $("sort").value = "newest";
        page = 1;
        render();
      });

      $("btnAdmin").addEventListener("click", openModal);
      $("btnCloseModal").addEventListener("click", closeModal);
      $("btnCancelUnlock").addEventListener("click", closeModal);

      $("modalBackdrop").addEventListener("click", (e)=>{
        if(e.target === $("modalBackdrop")) closeModal();
      });

      $("btnUnlock").addEventListener("click", doLogin);
      $("btnLogout").addEventListener("click", doLogout);
      $("btnLogoutTop").addEventListener("click", doLogout);

      $("btnNew").addEventListener("click", ()=>{
        if(!isAuthed() || !adminUnlocked){ toast("Admin locked."); return; }
        touchAdmin();
        resetForm();
        $("f_name").focus();
      });

      $("btnSave").addEventListener("click", saveFromForm);
      $("btnResetForm").addEventListener("click", ()=>{ touchAdmin(); resetForm(); });
      $("btnDelete").addEventListener("click", deleteEditing);

      // auto-lock
      setInterval(adminAutoLockTick, 2000);
      ["mousemove","keydown","click","touchstart"].forEach(evt=>{
        window.addEventListener(evt, ()=>{ if(adminUnlocked) touchAdmin(); }, { passive:true });
      });
    }

    // Init
    wire();
    render();
    setAuthUI();
  </script>
</body>
</html>
